<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vozes — Comunidade</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg: #0f172a; --card:#0b1220; --text:#e6eef8; --accent:#6ee7b7;
    }
    [data-theme="ocean"]{ --bg:#0f172a; --card:#071029; --text:#e6f7ff; --accent:#60a5fa }
    [data-theme="sunset"]{ --bg:#fff7f0; --card:#fff1e6; --text:#2b2b2b; --accent:#f97316 }
    [data-theme="mint"]{ --bg:#f6fffb; --card:#ecfff5; --text:#03251a; --accent:#34d399 }

    body{ background:var(--bg); color:var(--text); }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); background-color:var(--card); color:var(--text); }
    .accent{ color:var(--accent); }
    .btn-accent{ background:var(--accent); color:inherit }
    .img-thumb{ max-height:110px; object-fit:cover; border-radius:6px }

    /* simple passport style */
    .passport{ display:flex; gap:1rem; align-items:flex-start }
    .passport .avatar{ width:110px; height:140px; border-radius:6px; object-fit:cover; border:4px solid rgba(255,255,255,0.06) }
  </style>
</head>
<body data-theme="ocean" class="min-h-screen antialiased">
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold">Vozes</h1>
        <p class="text-sm opacity-80">Um espaço para criar, buscar e compartilhar personagens — cada usuário pode postar uma "passaporte" do personagem, adicionar imagens, ditar descrições e comentar nos posts.</p>
      </div>

      <div class="flex items-center gap-3">
        <input id="search" type="search" placeholder="Pesquisar por nome..." class="px-3 py-2 rounded-md bg-white/5 placeholder:opacity-60 outline-none" />

        <div class="relative">
          <button id="themeBtn" class="px-3 py-2 rounded-md card">Paleta</button>
          <div id="themeMenu" class="hidden absolute right-0 mt-2 w-40 card p-2 rounded-md shadow-lg">
            <button class="w-full text-left px-2 py-2 rounded hover:bg-white/5" data-theme="ocean">Ocean (padrão)</button>
            <button class="w-full text-left px-2 py-2 rounded hover:bg-white/5" data-theme="sunset">Sunset</button>
            <button class="w-full text-left px-2 py-2 rounded hover:bg-white/5" data-theme="mint">Mint</button>
          </div>
        </div>

        <button id="newPostBtn" class="px-4 py-2 rounded-md btn-accent">Novo Post</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="col-span-1 lg:col-span-2 space-y-4">
        <div id="posts" class="space-y-4">
          <!-- posts render here -->
        </div>
      </section>

      <aside class="card p-4 rounded-md hidden lg:block">
        <h2 class="text-xl font-semibold mb-2">Como usar</h2>
        <ol class="list-decimal ml-5 space-y-1 text-sm opacity-90">
          <li>Pesquise um personagem pelo nome no campo superior.</li>
          <li>Crie um post com foto de perfil, imagens e descrição (modelo passaporte disponível no formulário).</li>
          <li>Use o botão de ditado na criação para escrever por voz (navegadores modernos).</li>
          <li>Comente nos posts de outros usuários e curta suas criações.</li>
          <li>A paleta pode ser trocada no botão "Paleta" no canto superior direito.</li>
        </ol>
      </aside>
    </main>

    <footer class="mt-8 text-xs opacity-80">Feito para a comunidade <strong>Vozes</strong>. Dados armazenados localmente no navegador (localStorage).</footer>
  </div>

  <!-- Modal: New Post -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="w-full max-w-2xl card rounded-lg p-5 shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Criar post — Modelo Passaporte</h3>
        <button id="closeModal" class="text-sm px-3 py-1 rounded-md">Fechar</button>
      </div>

      <form id="postForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Nome do personagem</label>
            <input id="pName" required class="w-full px-3 py-2 rounded-md bg-white/5 outline-none" />
          </div>
          <div>
            <label class="text-sm">Foto de perfil</label>
            <input id="pAvatar" type="file" accept="image/*" class="w-full text-sm" />
          </div>
        </div>

        <div>
          <label class="text-sm">Descrição (pode ditar)</label>
          <div class="flex gap-2">
            <textarea id="pDesc" rows="4" class="flex-1 px-3 py-2 rounded-md bg-white/5 outline-none" required></textarea>
            <div class="flex flex-col gap-2">
              <button id="startDict" type="button" class="px-3 py-2 rounded-md card">Iniciar ditado</button>
              <button id="stopDict" type="button" class="px-3 py-2 rounded-md card hidden">Parar</button>
            </div>
          </div>
        </div>

        <div>
          <label class="text-sm">Imagens que identificam o personagem (várias)</label>
          <input id="pImages" type="file" accept="image/*" multiple class="w-full text-sm" />
        </div>

        <div class="flex items-center gap-3 justify-end">
          <button type="submit" class="px-4 py-2 rounded-md btn-accent">Postar</button>
        </div>
      </form>
    </div>
  </div>

  <template id="postTemplate">
    <article class="card p-4 rounded-md">
      <div class="passport">
        <img class="avatar" src="" alt="avatar" />
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold name"></h3>
              <div class="text-xs opacity-80 meta"></div>
            </div>
            <div class="space-x-2">
              <button class="px-3 py-1 rounded-md card btn-comment">Comentar</button>
            </div>
          </div>

          <p class="mt-3 desc"></p>

          <div class="mt-3 images grid grid-cols-3 gap-2"></div>

          <div class="mt-3 commentsArea hidden">
            <div class="space-y-2 existingComments"></div>
            <form class="mt-2 commentForm flex gap-2">
              <input class="flex-1 px-3 py-2 rounded-md bg-white/5 commentInput" placeholder="Escreva um comentário..." />
              <button class="px-3 py-2 rounded-md btn-accent">Enviar</button>
            </form>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
    // --- Utilities: localStorage posts ---
    function loadPosts(){
      try{ return JSON.parse(localStorage.getItem('vozes_posts')||'[]') }catch(e){ return [] }
    }
    function savePosts(arr){ localStorage.setItem('vozes_posts', JSON.stringify(arr)) }

    // --- Theme handling ---
    const themeBtn = document.getElementById('themeBtn');
    const themeMenu = document.getElementById('themeMenu');
    document.querySelectorAll('#themeMenu button').forEach(b=> b.addEventListener('click', e=>{
      const t = e.currentTarget.dataset.theme; document.body.setAttribute('data-theme', t); localStorage.setItem('vozes_theme', t); themeMenu.classList.add('hidden');
    }));
    themeBtn.addEventListener('click', ()=> themeMenu.classList.toggle('hidden'));
    // load theme
    const savedTheme = localStorage.getItem('vozes_theme')||'ocean'; document.body.setAttribute('data-theme', savedTheme);

    // --- Modal new post ---
    const modal = document.getElementById('modal');
    document.getElementById('newPostBtn').addEventListener('click', ()=> modal.classList.remove('hidden'));
    document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.add('hidden'));

    // --- Dictation (Web Speech API) ---
    let recognition, dictating=false;
    const startDict = document.getElementById('startDict');
    const stopDict = document.getElementById('stopDict');
    const pDesc = document.getElementById('pDesc');
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR(); recognition.lang = 'pt-BR'; recognition.interimResults = false; recognition.continuous = true;
      recognition.onresult = (e)=>{
        let text = '';
        for(let i = e.resultIndex; i<e.results.length; i++) text += e.results[i][0].transcript;
        pDesc.value += (pDesc.value? ' ' : '') + text;
      }
      recognition.onerror = (e)=>{ console.warn('speech error', e) }
    } else {
      startDict.disabled = true; startDict.title = 'Ditado não suportado neste navegador';
    }

    startDict.addEventListener('click', ()=>{
      if(!recognition) return; recognition.start(); dictating=true; startDict.classList.add('hidden'); stopDict.classList.remove('hidden');
    })
    stopDict.addEventListener('click', ()=>{ if(recognition) recognition.stop(); dictating=false; stopDict.classList.add('hidden'); startDict.classList.remove('hidden'); })

    // --- File to dataURL helper ---
    function fileToDataURL(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = rej; fr.readAsDataURL(file);
      })
    }

    // --- Submit post ---
    const postForm = document.getElementById('postForm');
    postForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const name = document.getElementById('pName').value.trim();
      const avatarF = document.getElementById('pAvatar').files[0];
      const desc = document.getElementById('pDesc').value.trim();
      const imgs = Array.from(document.getElementById('pImages').files);
      const now = new Date().toISOString();
      const avatar = avatarF? await fileToDataURL(avatarF) : '';
      const images = [];
      for(const f of imgs){ images.push(await fileToDataURL(f)) }

      const posts = loadPosts();
      posts.unshift({ id: Date.now(), name, desc, avatar, images, comments: [], createdAt: now });
      savePosts(posts);
      renderPosts(posts);
      postForm.reset();
      modal.classList.add('hidden');
    })

    // --- Rendering posts ---
    const postsEl = document.getElementById('posts');
    const template = document.getElementById('postTemplate');
    function renderPosts(posts){
      postsEl.innerHTML = '';
      for(const p of posts){
        const node = template.content.cloneNode(true);
        const article = node.querySelector('article');
        const avatar = node.querySelector('.avatar'); avatar.src = p.avatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="280"><rect width="100%" height="100%" fill="%230b1220"/><text x="50%" y="50%" fill="%23fff" font-size="20" text-anchor="middle">Sem+Foto</text></svg>';
        node.querySelector('.name').textContent = p.name;
        node.querySelector('.meta').textContent = new Date(p.createdAt).toLocaleString();
        node.querySelector('.desc').textContent = p.desc;
        const imagesWrap = node.querySelector('.images');
        p.images.forEach(src=>{ const img = document.createElement('img'); img.src = src; img.className = 'img-thumb'; imagesWrap.appendChild(img) })

        const commentsArea = node.querySelector('.commentsArea');
        const existing = node.querySelector('.existingComments');
        function refreshComments(){ existing.innerHTML = ''; for(const c of p.comments){ const div = document.createElement('div'); div.className='text-sm p-2 rounded-md bg-white/3'; div.innerHTML = `<strong>${escapeHtml(c.author)}</strong> <span class="opacity-80 text-xs">- ${new Date(c.at).toLocaleString()}</span><div class="mt-1">${escapeHtml(c.text)}</div>`; existing.appendChild(div) } }
        refreshComments();

        // comment toggle
        const btnComment = node.querySelector('.btn-comment');
        btnComment.addEventListener('click', ()=> commentsArea.classList.toggle('hidden'));

        // submit comment
        const commentForm = node.querySelector('.commentForm');
        commentForm.addEventListener('submit', (ev)=>{
          ev.preventDefault(); const input = commentForm.querySelector('.commentInput'); const text = input.value.trim(); if(!text) return; const author = 'Anon'; p.comments.push({ author, text, at: new Date().toISOString() }); saveSinglePost(p); refreshComments(); input.value='';
        })

        postsEl.appendChild(node);
      }
    }

    function saveSinglePost(post){
      const posts = loadPosts(); const idx = posts.findIndex(x=>x.id===post.id); if(idx>=0) posts[idx]=post; else posts.unshift(post); savePosts(posts);
    }

    // escape simple
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    // --- Search ---
    const search = document.getElementById('search');
    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase(); const all = loadPosts(); if(!q){ renderPosts(all); return } const filtered = all.filter(p=> p.name.toLowerCase().includes(q)); renderPosts(filtered);
    })

    // --- Init ---
    renderPosts(loadPosts());

    // Close menu on outside click
    document.addEventListener('click', (e)=>{
      if(!themeBtn.contains(e.target) && !themeMenu.contains(e.target)) themeMenu.classList.add('hidden');
    })

    // keyboard shortcut: new post (n)
    document.addEventListener('keydown', (e)=>{ if(e.key==='n' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') modal.classList.remove('hidden') })
  </script>
</body>
</html>
